datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id           String    @id @default(uuid())
  email        String    @unique
  password     String
  name         String?
  nickname     String?
  bio          String?   @db.Text
  profilePic   String?
  birthDate    DateTime?
  age          Int       @default(0)
  isAdult      Boolean   @default(false)
  language     String    @default("ko")
  isPrivate    Boolean   @default(false)
  createdAt    DateTime  @default(now())

  posts        Post[]
  comments     Comment[]
  postLikes    PostLike[]
  commentLikes CommentLike[]

  reportsMade     Report[] @relation("Reporter")
  reportsReceived Report[] @relation("TargetUser")

  sentMessages     Message[] @relation("SentMessages")
  receivedMessages Message[] @relation("ReceivedMessages")
  followers        Follow[]  @relation("following")
  following        Follow[]  @relation("follower")

  notifications        Notification[] @relation("UserNotifications")
  createdNotifications Notification[] @relation("NotificationCreator")

  @@map("users")
}

model Post {
  id            String   @id @default(uuid())
  content       String   @db.Text
  imageUrl      String?
  isSafe        Boolean  @default(true)
  isSafeContent Boolean  @default(true)
  views         Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  authorId      String
  author        User     @relation(fields: [authorId], references: [id], onDelete: Cascade)

  comments      Comment[]
  likes         PostLike[]
  reports       Report[] @relation("TargetPost")

  @@map("posts")
}

model Comment {
  id        String   @id @default(uuid())
  content   String   @db.Text
  createdAt DateTime @default(now())

  postId    String
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)

  authorId  String
  author    User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  likes     CommentLike[]
  reports   Report[] @relation("TargetComment")

  @@map("comments")
}

model PostLike {
  userId String
  postId String
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)
  post   Post @relation(fields: [postId], references: [id], onDelete: Cascade)
  @@id([userId, postId])
  @@map("post_likes")
}

model CommentLike {
  userId    String
  commentId String
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  comment   Comment @relation(fields: [commentId], references: [id], onDelete: Cascade)
  @@id([userId, commentId])
  @@map("comment_likes")
}

model Message {
  id         String   @id @default(uuid())
  content    String   @db.Text
  isRead     Boolean  @default(false)
  isLiked    Boolean  @default(false)
  createdAt  DateTime @default(now())

  senderId   String
  sender     User     @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  receiverId String
  receiver   User     @relation("ReceivedMessages", fields: [receiverId], references: [id], onDelete: Cascade)

  @@index([senderId, receiverId, createdAt])
  @@map("messages")
}

model Follow {
  followerId  String
  followingId String
  createdAt   DateTime @default(now())

  follower    User @relation("follower", fields: [followerId], references: [id], onDelete: Cascade)
  following   User @relation("following", fields: [followingId], references: [id], onDelete: Cascade)

  @@id([followerId, followingId])
  @@map("follows")
}

// [Fact] 외래 키(FK) 이름 충돌 해결을 위해 map 명시적 추가
model Report {
  id         String   @id @default(uuid())
  reason     String   @default("부적절한 콘텐츠")
  type       String   @default("POST")
  status     String   @default("PENDING")
  createdAt  DateTime @default(now())

  reporterId String
  reporter   User     @relation("Reporter", fields: [reporterId], references: [id], onDelete: Cascade, map: "reports_reporterId_fkey_custom")

  targetId   String?
  targetUser User?    @relation("TargetUser", fields: [targetId], references: [id], onDelete: Cascade, map: "reports_targetId_fkey_custom")

  postId     String?
  post       Post?    @relation("TargetPost", fields: [postId], references: [id], onDelete: Cascade, map: "reports_postId_fkey_custom")

  commentId  String?
  comment    Comment? @relation("TargetComment", fields: [commentId], references: [id], onDelete: Cascade, map: "reports_commentId_fkey_custom")

  @@index([reporterId])
  @@index([targetId])
  @@index([postId])
  @@map("reports")
}

model Notification {
  id          String   @id @default(uuid())
  type        String
  isRead      Boolean  @default(false)
  createdAt   DateTime @default(now())

  userId      String
  user        User     @relation("UserNotifications", fields: [userId], references: [id], onDelete: Cascade)

  creatorId   String
  creator     User     @relation("NotificationCreator", fields: [creatorId], references: [id], onDelete: Cascade)

  postId      String?
  commentId   String?

  @@index([userId])
  @@map("notifications")
}