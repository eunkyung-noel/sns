datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id         String    @id @default(uuid())
  email      String    @unique
  password   String
  name       String?
  nickname   String?
  bio        String?   @db.Text
  profilePic String?
  birthDate  DateTime?
  age        Int       @default(0)
  language   String    @default("ko")
  isPrivate  Boolean   @default(false)
  createdAt  DateTime  @default(now())

  posts        Post[]
  comments     Comment[]
  postLikes    PostLike[]
  commentLikes CommentLike[]

  reportsMade     Report[] @relation("Reporter")
  reportsReceived Report[] @relation("TargetUser")

  sentMessages     Message[] @relation("SentMessages")
  receivedMessages Message[] @relation("ReceivedMessages")
  followers        Follow[]  @relation("following")
  following        Follow[]  @relation("follower")

  // [추가] 알림 관계
  notifications        Notification[] @relation("UserNotifications")
  createdNotifications Notification[] @relation("NotificationCreator")

  @@map("users")
}

model Post {
  id            String   @id @default(uuid())
  content       String   @db.Text
  imageUrl      String?
  isSafe        Boolean  @default(true)
  isSafeContent Boolean  @default(true)
  views         Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  authorId String
  author   User   @relation(fields: [authorId], references: [id], onDelete: Cascade)

  comments Comment[]
  likes    PostLike[]
  reports  Report[]   @relation("TargetPost")

  @@map("posts")
}

model Comment {
  id        String   @id @default(uuid())
  content   String   @db.Text
  createdAt DateTime @default(now())

  postId String
  post   Post   @relation(fields: [postId], references: [id], onDelete: Cascade)

  authorId String
  author   User          @relation(fields: [authorId], references: [id], onDelete: Cascade)
  likes    CommentLike[]
  reports  Report[]      @relation("TargetComment")

  @@map("comments")
}

model PostLike {
  userId String
  postId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  post   Post   @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@id([userId, postId])
  @@map("post_likes")
}

model CommentLike {
  userId    String
  commentId String
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  comment   Comment @relation(fields: [commentId], references: [id], onDelete: Cascade)

  @@id([userId, commentId])
  @@map("comment_likes")
}

model Message {
  id        String   @id @default(uuid())
  content   String   @db.Text
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  senderId   String
  sender     User   @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  receiverId String
  receiver   User   @relation("ReceivedMessages", fields: [receiverId], references: [id], onDelete: Cascade)

  @@index([senderId, receiverId, createdAt])
  @@map("messages")
}

model Follow {
  followerId  String
  followingId String
  createdAt   DateTime @default(now())

  follower  User @relation("follower", fields: [followerId], references: [id], onDelete: Cascade)
  following User @relation("following", fields: [followingId], references: [id], onDelete: Cascade)

  @@id([followerId, followingId])
  @@map("follows")
}

model Report {
  id        String   @id @default(uuid())
  reason    String   @default("부적절한 콘텐츠")
  type      String   @default("POST")
  status    String   @default("PENDING")
  createdAt DateTime @default(now())

  reporterId String
  reporter   User   @relation("Reporter", fields: [reporterId], references: [id], onDelete: Cascade)

  targetId String
  target   User   @relation("TargetUser", fields: [targetId], references: [id], onDelete: Cascade)

  postId String?
  post   Post?   @relation("TargetPost", fields: [postId], references: [id], onDelete: Cascade)

  commentId String?
  comment   Comment? @relation("TargetComment", fields: [commentId], references: [id], onDelete: Cascade)

  @@index([reporterId])
  @@index([targetId])
  @@map("reports")
}

// [추가] 알림 모델
model Notification {
  id        String   @id @default(uuid())
  type      String // "FOLLOW", "LIKE", "COMMENT", "MESSAGE"
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  userId String // 알림을 받는 사람
  user   User   @relation("UserNotifications", fields: [userId], references: [id], onDelete: Cascade)

  creatorId String // 알림을 발생시킨 사람
  creator   User   @relation("NotificationCreator", fields: [creatorId], references: [id], onDelete: Cascade)

  postId    String? // 관련 게시글
  commentId String? // 관련 댓글

  @@index([userId])
  @@map("notifications")
}
