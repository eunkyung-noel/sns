AWSTemplateFormatVersion: '2010-09-09'
Description: 'noel-infrastructure-rds-migration-v12-noel0214'

Resources:
  noelvpc:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 172.17.0.0/16
      EnableDnsSupport: true
      EnableDnsHostnames: true
      Tags: [{Key: Name, Value: noel-vpc}]

  noelsnsigw:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags: [{Key: Name, Value: noelsns-igw}]

  noelVpcIgwAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref noelvpc
      InternetGatewayId: !Ref noelsnsigw

  publicsubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref noelvpc
      CidrBlock: 172.17.1.0/24
      AvailabilityZone: ap-northeast-2a
      MapPublicIpOnLaunch: true
      Tags: [{Key: Name, Value: noel-public-sns}]

  privatesubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref noelvpc
      CidrBlock: 172.17.2.0/24
      AvailabilityZone: ap-northeast-2a
      Tags: [{Key: Name, Value: noel-private-sns}]

  privatesubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref noelvpc
      CidrBlock: 172.17.3.0/24
      AvailabilityZone: ap-northeast-2c
      Tags: [{Key: Name, Value: noel-private-sns01}]

  publicroutetable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref noelvpc
      Tags: [{Key: Name, Value: noel-public-rt}]

  publicroute:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref publicroutetable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref noelsnsigw

  publicsubnetassociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref publicsubnet
      RouteTableId: !Ref publicroutetable

  publicsg:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: allow ssh, http, and app ports
      VpcId: !Ref noelvpc
      SecurityGroupIngress:
        - {IpProtocol: tcp, FromPort: 22, ToPort: 22, CidrIp: 0.0.0.0/0}
        - {IpProtocol: tcp, FromPort: 80, ToPort: 80, CidrIp: 0.0.0.0/0}
        - {IpProtocol: tcp, FromPort: 3000, ToPort: 3000, CidrIp: 0.0.0.0/0}
        - {IpProtocol: tcp, FromPort: 5001, ToPort: 5001, CidrIp: 0.0.0.0/0}
        - {IpProtocol: tcp, FromPort: 3306, ToPort: 3306, CidrIp: 0.0.0.0/0}
      Tags: [{Key: Name, Value: noel-sg}]

  noelDBSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: Group for noel RDS
      SubnetIds:
        - !Ref privatesubnet1
        - !Ref privatesubnet2

  noelRDSInstance:
    Type: AWS::RDS::DBInstance
    Properties:
      DBInstanceIdentifier: noel-RDS
      DBInstanceClass: db.t3.micro
      Engine: mysql
      EngineVersion: "8.0"
      MasterUsername: admin
      MasterUserPassword: "noel0214"
      AllocatedStorage: '20'
      DBName: safe_sns
      VPCSecurityGroups: [!Ref publicsg]
      DBSubnetGroupName: !Ref noelDBSubnetGroup
      PubliclyAccessible: true
      Tags: [{Key: Name, Value: noel-RDS}]

  noelAppServer:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: t2.micro
      ImageId: ami-040c33c6a51fd5d96
      KeyName: noel-final
      SubnetId: !Ref publicsubnet
      SecurityGroupIds: [!Ref publicsg]
      Tags: [{Key: Name, Value: noel-app-server}]
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          # 1. 초기 환경 설치
          sudo apt-get update -y
          curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
          sudo apt-get install -y nodejs git mysql-client
          sudo npm install -g pm2 serve

          # 2. 작업 디렉토리 생성
          mkdir -p /home/ubuntu/app
          
          # 3. 백엔드 배포
          cd /home/ubuntu/app
          git clone -b backend-service https://github.com/eunkyung-noel/sns.git backend
          cd backend
          echo "DATABASE_URL=\"mysql://admin:noel0214@${noelRDSInstance.Endpoint.Address}:3306/safe_sns\"" > .env
          echo "JWT_SECRET=\"noelsecret123\"" >> .env
          echo "PORT=5001" >> .env
          npm install
          npx prisma generate
          sleep 60
          npx prisma db push
          pm2 start src/server.js --name "noel-backend" || pm2 start src/app.js --name "noel-backend"

          # 4. 프론트엔드 배포
          cd /home/ubuntu/app
          git clone -b main https://github.com/eunkyung-noel/sns.git frontend-repo
          cd frontend-repo/frontend
          TOKEN=$(curl -X PUT "http://169.254.169.254/latest/api/token" -H "X-aws-ec2-metadata-token-ttl-seconds: 21600")
          PUBLIC_IP=$(curl -H "X-aws-ec2-metadata-token: $TOKEN" -s http://169.254.169.254/latest/meta-data/public-ipv4)
          echo "REACT_APP_API_URL=http://$PUBLIC_IP:5001" > .env
          npm install
          npm run build
          pm2 serve build 3000 --name "noel-frontend" --spa

          # 5. 권한 수정 (중요: GitHub Actions 접속 시 권한 에러 방지)
          sudo chown -R ubuntu:ubuntu /home/ubuntu/app
          sudo env PATH=$PATH:/usr/bin /usr/lib/node_modules/pm2/bin/pm2 startup systemd -u ubuntu --hp /home/ubuntu
          pm2 save
